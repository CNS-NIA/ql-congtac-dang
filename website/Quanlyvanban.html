<?php
// upload.php - Xử lý upload file lên server

// Cho phép CORS (để gọi từ JavaScript)
header('Access-Control-Allow-Origin: *');
header('Content-Type: application/json');

// Kiểm tra xem có file được gửi lên không
if (!isset($_FILES['file']) || $_FILES['file']['error'] !== UPLOAD_ERR_OK) {
    echo json_encode(['success' => false, 'error' => 'Không có file được upload']);
    exit;
}

// Lấy thông tin file
$file = $_FILES['file'];
$fileName = $file['name'];
$fileSize = $file['size'];
$fileTmpName = $file['tmp_name'];

// Kiểm tra kích thước file (tối đa 10MB)
$maxSize = 10 * 1024 * 1024; // 10MB
if ($fileSize > $maxSize) {
    echo json_encode(['success' => false, 'error' => 'File quá lớn (tối đa 10MB)']);
    exit;
}

// Kiểm tra định dạng file
$allowedExtensions = ['pdf', 'doc', 'docx'];
$fileExtension = strtolower(pathinfo($fileName, PATHINFO_EXTENSION));

if (!in_array($fileExtension, $allowedExtensions)) {
    echo json_encode(['success' => false, 'error' => 'Chỉ chấp nhận file PDF, DOC, DOCX']);
    exit;
}

// Tạo tên file mới để tránh trùng
$newFileName = date('Ymd_His') . '_' . uniqid() . '.' . $fileExtension;

// Đường dẫn lưu file (THAY ĐỔI ĐƯỜNG DẪN NÀY THEO CẤU TRÚC THƯ MỤC CỦA ANH)
$uploadPath = __DIR__ . '/../uploads/' . $newFileName;

// Di chuyển file từ thư mục tạm sang thư mục uploads
if (move_uploaded_file($fileTmpName, $uploadPath)) {
    echo json_encode([
        'success' => true,
        'message' => 'Upload file thành công',
        'fileName' => $newFileName,
        'originalName' => $fileName,
        'fileSize' => $fileSize,
        'filePath' => 'uploads/' . $newFileName
    ]);
} else {
    echo json_encode(['success' => false, 'error' => 'Không thể lưu file']);
}
?>
